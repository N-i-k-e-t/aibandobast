// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Event model - represents a major event like Ganpati Utsav
model Event {
  id          String   @id @default(uuid())
  eventName   String   @map("event_name")
  eventYear   Int      @map("event_year")
  eventType   String   @map("event_type")
  city        String
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  ghats         Ghat[]
  eventUnits    EventUnit[]
  routes        Route[]
  zones         Zone[]
  evidenceFiles EvidenceFile[]
  decisionNotes DecisionNote[]

  @@map("events")
}

// Police Station model
model PoliceStation {
  id           String  @id @default(uuid())
  psName       String  @map("ps_name")
  divisionName String  @map("division_name")
  city         String
  state        String
  contactPhone String? @map("contact_phone")
  contactEmail String? @map("contact_email")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  eventUnits    EventUnit[]
  routes        Route[]
  zones         Zone[]
  evidenceFiles EvidenceFile[]

  @@map("police_stations")
}

// Ghat model - immersion points
model Ghat {
  id          String  @id @default(uuid())
  eventId     String  @map("event_id")
  ghatName    String  @map("ghat_name")
  address     String?
  latitude    Float
  longitude   Float
  capacityEst Int?    @map("capacity_est")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  event         Event          @relation(fields: [eventId], references: [id])
  routes        Route[]
  evidenceFiles EvidenceFile[]

  @@map("ghats")
}

// Event Unit model - mandals/organizers
model EventUnit {
  id                 String   @id @default(uuid())
  eventId            String   @map("event_id")
  psId               String   @map("ps_id")
  unitName           String   @map("unit_name")
  unitType           String   @map("unit_type")
  headName           String?  @map("head_name")
  headPhone          String?  @map("head_phone")
  address            String?
  landmark           String?
  latitude           Float?
  longitude          Float?
  geocodeSource      String?  @map("geocode_source")
  geocodeConfidence  Float?   @map("geocode_confidence")
  crowdMin           Int?     @map("crowd_min")
  crowdMax           Int?     @map("crowd_max")
  riskTier           String   @default("LOW") @map("risk_tier")
  sensitiveFlag      Boolean  @default(false) @map("sensitive_flag")
  pastIncidentFlag   Boolean  @default(false) @map("past_incident_flag")
  pastIncidentNotes  String?  @map("past_incident_notes")
  volunteersCount    Int?     @map("volunteers_count")
  cctvAvailable      Boolean  @default(false) @map("cctv_available")
  cctvCount          Int?     @map("cctv_count")
  permissionsStatus  String?  @map("permissions_status")
  permissionsNotes   String?  @map("permissions_notes")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  event          Event          @relation(fields: [eventId], references: [id])
  policeStation  PoliceStation  @relation(fields: [psId], references: [id])
  routes         Route[]
  evidenceFiles  EvidenceFile[]

  @@map("event_units")
}

// Route model - procession routes
model Route {
  id              String   @id @default(uuid())
  eventId         String   @map("event_id")
  psId            String   @map("ps_id")
  routeName       String   @map("route_name")
  routeType       String   @map("route_type")
  startLabel      String?  @map("start_label")
  startLat        Float?   @map("start_lat")
  startLng        Float?   @map("start_lng")
  endLabel        String?  @map("end_label")
  endLat          Float?   @map("end_lat")
  endLng          Float?   @map("end_lng")
  unitId          String?  @map("unit_id")
  ghatId          String?  @map("ghat_id")
  timeStart       String?  @map("time_start")
  timeEnd         String?  @map("time_end")
  distanceKm      Float?   @map("distance_km")
  durationMin     Int?     @map("duration_min")
  encodedPolyline String?  @map("encoded_polyline")
  polylineGeojson String?  @map("polyline_geojson")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  event          Event          @relation(fields: [eventId], references: [id])
  policeStation  PoliceStation  @relation(fields: [psId], references: [id])
  eventUnit      EventUnit?     @relation(fields: [unitId], references: [id])
  ghat           Ghat?          @relation(fields: [ghatId], references: [id])
  evidenceFiles  EvidenceFile[]

  @@map("routes")
}

// Zone model - geographic zones
model Zone {
  id             String   @id @default(uuid())
  eventId        String   @map("event_id")
  psId           String   @map("ps_id")
  zoneName       String   @map("zone_name")
  zoneType       String   @map("zone_type")
  riskTier       String   @default("LOW") @map("risk_tier")
  polygonGeojson String   @map("polygon_geojson")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  event          Event          @relation(fields: [eventId], references: [id])
  policeStation  PoliceStation  @relation(fields: [psId], references: [id])
  evidenceFiles  EvidenceFile[]

  @@map("zones")
}

// Evidence File model
model EvidenceFile {
  id          String   @id @default(uuid())
  eventId     String   @map("event_id")
  psId        String?  @map("ps_id")
  unitId      String?  @map("unit_id")
  routeId     String?  @map("route_id")
  ghatId      String?  @map("ghat_id")
  zoneId      String?  @map("zone_id")
  stageTag    String   @map("stage_tag")
  category    String
  title       String
  description String?
  tags        String   @default("[]") // JSON array stored as string
  fileUrl     String   @map("file_url")
  fileType    String   @map("file_type")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  // Relations
  event         Event          @relation(fields: [eventId], references: [id])
  policeStation PoliceStation? @relation(fields: [psId], references: [id])
  eventUnit     EventUnit?     @relation(fields: [unitId], references: [id])
  route         Route?         @relation(fields: [routeId], references: [id])
  ghat          Ghat?          @relation(fields: [ghatId], references: [id])
  zone          Zone?          @relation(fields: [zoneId], references: [id])

  @@map("evidence_files")
}

// Decision Note model - documents decision rationale per stage
model DecisionNote {
  id              String   @id @default(uuid())
  eventId         String   @map("event_id")
  stageTag        String   @map("stage_tag")
  title           String
  whatWeHad       String   @map("what_we_had")
  whatWeConsidered String  @map("what_we_considered")
  whyWeDecided    String   @map("why_we_decided")
  evidenceLinks   String   @default("[]") @map("evidence_links") // JSON array of file IDs
  aiGisAssistNote String?  @map("ai_gis_assist_note")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id])

  @@map("decision_notes")
}

// Audit Log model - tracks all actions
model AuditLog {
  id         String   @id @default(uuid())
  action     String
  actor      String
  timestamp  DateTime @default(now())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  details    String?

  @@map("audit_logs")
}

// Archive Year model - for 10-year archive
model ArchiveYear {
  id                String   @id @default(uuid())
  year              Int      @unique
  eventName         String   @map("event_name")
  totalUnits        Int      @default(0) @map("total_units")
  totalRoutes       Int      @default(0) @map("total_routes")
  totalGhats        Int      @default(0) @map("total_ghats")
  totalPoliceStations Int    @default(0) @map("total_police_stations")
  estimatedCrowd    Int      @default(0) @map("estimated_crowd")
  incidentsReported Int      @default(0) @map("incidents_reported")
  resourcesDeployed Int      @default(0) @map("resources_deployed")
  notes             String?
  documentsJson     String   @default("[]") @map("documents_json") // JSON array of document references
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("archive_years")
}
